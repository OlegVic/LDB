# LDB - Локальная система базы данных

## Обзор

LDB - это комплексная система базы данных продуктов, которая обеспечивает хранение, поиск и API-доступ к информации о продуктах. Система включает функциональность для импорта данных из внешних источников, обновления справочных данных из Google Sheets и предоставления информации о продуктах через REST API.

## Компоненты

### Модели базы данных

Система использует SQLAlchemy ORM с PostgreSQL в качестве бэкенда базы данных. Основные модели включают:

- **Product**: Основная информация о продукте (артикул, наименование, класс)
- **ClassClarify**: Информация о классификации продукта
- **CharacteristicClarify**: Определения характеристик продукта
- **ProductCharacteristic**: Значения характеристик конкретного продукта
- **ProductAnalog**: Альтернативные продукты (аналоги)
- **ProductBarcode**: Штрих-коды продукта
- **ProductCertificate**: Сертификаты продукта
- **ProductInstruction**: Инструкции к продукту
- **ProductPhoto**: Фотографии продукта
- **ProductPrice**: Информация о ценах на продукт

### API

Система предоставляет два типа API:

1. **Search API** (api.py): REST API для структурированного поиска продуктов
   - `/search/structured`: Базовый структурированный поиск
   - `/search/structured_v2`: Улучшенный структурированный поиск с расширенной фильтрацией

2. **1C API Client** (api1C.py): Клиент для доступа к внешнему API 1C
   - Методы для получения данных о продуктах, ценах, остатках и т.д.

### Импорт данных

- **sds_import.py**: Основной скрипт для импорта данных из внешних источников
- **google_sheets_updater.py**: Скрипт для обновления справочных данных из Google Sheets

### Поисковая система

- **search.py**: Реализует расширенную функциональность поиска
- **product_info.py**: Предоставляет подробную информацию о продукте

## Установка

1. Установите зависимости:

```bash
pip install -r requirements.txt
```

2. Создайте файл окружения:

```bash
cp .env.example .env
```

3. Отредактируйте файл `.env`, указав необходимые значения для подключения к базе данных, API и другие настройки.

4. Создайте таблицы базы данных:

```bash
python create_tables.py
```

## Настройка окружения

Система использует переменные окружения для хранения чувствительных данных и настроек. Файл `.env.example` содержит шаблон с необходимыми переменными:

- `DATABASE_URL` - строка подключения к базе данных для синхронных операций
- `PG_DSN` - строка подключения к базе данных для асинхронных операций
- `API_TOKEN` - токен для доступа к API 1C
- `API_BASE_URL` - базовый URL для API 1C
- `API_PORT` - порт для запуска API
- `GOOGLE_SPREADSHEET_ID` - ID Google таблицы
- `GOOGLE_CLASSES_GID` - GID вкладки с классами
- `GOOGLE_CHARACTERISTICS_GID` - GID вкладки с характеристиками

## Использование

### Запуск API

```bash
python api.py
```

API будет доступен по адресу http://localhost:9898 (или по порту, указанному в переменной окружения API_PORT)

### Импорт данных

```bash
python sds_import.py
```

### Обновление справочных данных

```bash
python google_sheets_updater.py
```

### Запуск тестов

```bash
python tests.py
```

## Документация API

### Структурированный поиск

**Endpoint:** `POST /search/structured`

**Формат запроса:**

```json
{
  "include": {
    "articles": ["01-0023", "KR-91-0840"],
    "keys": ["Кабель силовой", "Патч-корд"],
    "characteristics": {
      "Длина": ["3м", "2м"],
      "Цвет": ["синий"]
    }
  },
  "exclude": {
    "articles": [],
    "keys": [],
    "characteristics": {}
  }
}
```

**Формат ответа:**

```json
{
  "articles": ["01-0023", ...],
  "clarifications": {
    "classes": ["Кабель связи акустический", ...],
    "groups": ["Патч-корды", ...],
    "characteristics": {
      "Длина": ["3м", "2м", ...],
      "Цвет": ["синий", "красный", ...]
    }
  },
  "metadata": {
    "start_time": "2023-05-20 12:34:56",
    "end_time": "2023-05-20 12:34:57",
    "duration_seconds": 1.23
  }
}
```

### Улучшенный структурированный поиск (v2)

**Endpoint:** `POST /search/structured_v2`

Использует тот же формат запроса и ответа, что и базовый структурированный поиск, но с улучшенным алгоритмом поиска, который:

1. Сначала собирает все артикулы, соответствующие критериям "articles" и "keys"
2. Затем фильтрует эти результаты на основе критериев "characteristics"

## Структура проекта

```
ldb/
├── api.py                  # FastAPI REST API
├── api1C.py                # Клиент API 1C
├── create_tables.py        # Скрипт для создания таблиц базы данных
├── db.py                   # Настройка подключения к базе данных
├── google_sheets_updater.py # Обновление данных из Google Sheets
├── models.py               # Модели SQLAlchemy ORM
├── product_info.py         # Отображение информации о продукте
├── product_lookup.py       # Утилиты для поиска продуктов
├── README.md               # Этот файл
├── requirements.txt        # Зависимости проекта
├── sds_import.py           # Скрипт импорта данных
├── search.py               # Поисковая система
├── tests.py                # Набор тестов
└── test.http               # Примеры HTTP-запросов
```

## Зависимости

- FastAPI
- SQLAlchemy
- Pandas
- Requests
- aiohttp
- PostgreSQL
- python-dotenv
